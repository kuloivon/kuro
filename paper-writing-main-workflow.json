{
  "name": "è®ºæ–‡å†™ä½œä¸»å·¥ä½œæµ - æ–‡æ¡£å¤„ç†ä¸å†…å®¹æå–",
  "nodes": [
    {
      "parameters": {
        "triggerOn": "fileUpload",
        "options": {
          "allowedMimeTypes": ["application/pdf", "text/markdown", "text/plain"]
        }
      },
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "name": "æ–‡ä»¶ä¸Šä¼ è§¦å‘å™¨",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [100, 100],
      "webhookId": "paper-upload-trigger"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "={{ $json.mimetype }}",
            "operation": "equal",
            "rightValue": "application/pdf"
          }
        }
      },
      "id": "b2c3d4e5-f6g7-8901-bcde-f23456789012",
      "name": "PDFæ–‡ä»¶åˆ¤æ–­",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [300, 100]
    },
    {
      "parameters": {
        "functionCode": "// PDFå†…å®¹æå–\nconst pdfParse = require('pdf-parse');\nconst fs = require('fs');\n\nfor (const item of $input.all()) {\n  try {\n    const fileBuffer = Buffer.from(item.binary.data, 'base64');\n    const pdfData = await pdfParse(fileBuffer);\n    \n    // æå–æ–‡æœ¬å†…å®¹\n    const extractedText = pdfData.text;\n    const pageCount = pdfData.numpages;\n    \n    // åŸºç¡€ä¿¡æ¯æå–\n    const titleMatch = extractedText.match(/^(.{1,100})/m);\n    const title = titleMatch ? titleMatch[1].trim() : 'æœªè¯†åˆ«æ ‡é¢˜';\n    \n    // åˆ†æ®µå¤„ç†\n    const paragraphs = extractedText\n      .split('\\n\\n')\n      .filter(p => p.trim().length > 50)\n      .map(p => p.replace(/\\s+/g, ' ').trim());\n    \n    item.json = {\n      fileType: 'pdf',\n      originalFileName: item.json.filename || 'unknown.pdf',\n      title: title,\n      fullText: extractedText,\n      paragraphs: paragraphs,\n      pageCount: pageCount,\n      wordCount: extractedText.split(/\\s+/).length,\n      extractedAt: new Date().toISOString(),\n      processingStage: 'text_extracted'\n    };\n    \n    // ä¿ç•™åŸå§‹æ–‡ä»¶æ•°æ®\n    item.binary.originalFile = item.binary.data;\n    \n  } catch (error) {\n    item.json = {\n      error: 'PDFè§£æå¤±è´¥',\n      errorMessage: error.message,\n      processingStage: 'extraction_failed'\n    };\n  }\n}\n\nreturn $input.all();"
      },
      "id": "c3d4e5f6-g7h8-9012-cdef-345678901234",
      "name": "PDFå†…å®¹æå–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 80]
    },
    {
      "parameters": {
        "functionCode": "// Markdownå†…å®¹æå–\nconst marked = require('marked');\n\nfor (const item of $input.all()) {\n  try {\n    const fileContent = Buffer.from(item.binary.data, 'base64').toString('utf-8');\n    \n    // è§£æmarkdownç»“æ„\n    const tokens = marked.lexer(fileContent);\n    \n    // æå–æ ‡é¢˜\n    const headings = tokens.filter(token => token.type === 'heading');\n    const title = headings.length > 0 ? headings[0].text : 'æœªè¯†åˆ«æ ‡é¢˜';\n    \n    // æå–æ®µè½\n    const paragraphs = tokens\n      .filter(token => token.type === 'paragraph')\n      .map(token => token.text)\n      .filter(text => text.length > 50);\n    \n    // æå–å›¾ç‰‡å¼•ç”¨\n    const images = [];\n    const imageRegex = /!\\[([^\\]]*)\\]\\(([^\\)]+)\\)/g;\n    let match;\n    while ((match = imageRegex.exec(fileContent)) !== null) {\n      images.push({\n        alt: match[1],\n        src: match[2],\n        description: match[1] || 'å›¾ç‰‡æè¿°å¾…è¡¥å……'\n      });\n    }\n    \n    // æå–é“¾æ¥å¼•ç”¨\n    const links = [];\n    const linkRegex = /\\[([^\\]]+)\\]\\(([^\\)]+)\\)/g;\n    while ((match = linkRegex.exec(fileContent)) !== null) {\n      if (!match[2].match(/\\.(jpg|jpeg|png|gif|svg)$/i)) {\n        links.push({\n          text: match[1],\n          url: match[2]\n        });\n      }\n    }\n    \n    item.json = {\n      fileType: 'markdown',\n      originalFileName: item.json.filename || 'unknown.md',\n      title: title,\n      fullText: fileContent,\n      paragraphs: paragraphs,\n      headings: headings.map(h => ({ level: h.depth, text: h.text })),\n      images: images,\n      links: links,\n      wordCount: fileContent.split(/\\s+/).length,\n      extractedAt: new Date().toISOString(),\n      processingStage: 'text_extracted'\n    };\n    \n    item.binary.originalFile = item.binary.data;\n    \n  } catch (error) {\n    item.json = {\n      error: 'Markdownè§£æå¤±è´¥',\n      errorMessage: error.message,\n      processingStage: 'extraction_failed'\n    };\n  }\n}\n\nreturn $input.all();"
      },
      "id": "d4e5f6g7-h8i9-0123-def0-456789012345",
      "name": "Markdownå†…å®¹æå–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 200]
    },
    {
      "parameters": {},
      "id": "e5f6g7h8-i9j0-1234-ef01-567890123456",
      "name": "å†…å®¹åˆå¹¶",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [700, 140]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "={{ $json.processingStage }}",
            "operation": "equal",
            "rightValue": "extraction_failed"
          }
        }
      },
      "id": "f6g7h8i9-j0k1-2345-f012-678901234567",
      "name": "é”™è¯¯æ£€æŸ¥",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 140]
    },
    {
      "parameters": {
        "url": "{{ $('ç¯å¢ƒé…ç½®').item.json.llmApiUrl }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "{{ $('ç¯å¢ƒé…ç½®').item.json.llmModel }}"
            },
            {
              "name": "messages",
              "value": "=[{\"role\": \"system\", \"content\": \"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯æ–‡æ¡£åˆ†æä¸“å®¶ã€‚è¯·åˆ†ææä¾›çš„æ–‡æ¡£å†…å®¹ï¼Œæå–å…³é”®ä¿¡æ¯å¹¶æ•´ç†æˆç»“æ„åŒ–æ ¼å¼ã€‚\\n\\nåˆ†æè¦æ±‚ï¼š\\n1. è¯†åˆ«æ–‡æ¡£ä¸»é¢˜å’Œæ ¸å¿ƒè®ºç‚¹\\n2. æå–å…³é”®æ¦‚å¿µå’Œæœ¯è¯­\\n3. æ€»ç»“ä¸»è¦è®ºæ®å’Œæ”¯æŒè¯æ®\\n4. è¯†åˆ«å›¾è¡¨ã€æ•°æ®ç­‰è®ºæ®ç´ æ\\n5. ç”Ÿæˆç®€æ´çš„æ‘˜è¦\\n\\nè¾“å‡ºæ ¼å¼ä¸ºJSONï¼š\\n{\\n  \\\"title\\\": \\\"æ–‡æ¡£æ ‡é¢˜\\\",\\n  \\\"theme\\\": \\\"ä¸»è¦ä¸»é¢˜\\\",\\n  \\\"summary\\\": \\\"å†…å®¹æ‘˜è¦(200-300å­—)\\\",\\n  \\\"keyPoints\\\": [\\\"å…³é”®ç‚¹1\\\", \\\"å…³é”®ç‚¹2\\\"],\\n  \\\"evidence\\\": {\\n    \\\"textual\\\": [\\\"æ–‡å­—è®ºæ®1\\\", \\\"æ–‡å­—è®ºæ®2\\\"],\\n    \\\"visual\\\": [\\\"å›¾è¡¨æè¿°1\\\", \\\"å›¾è¡¨æè¿°2\\\"]\\n  },\\n  \\\"concepts\\\": [\\\"æ¦‚å¿µ1\\\", \\\"æ¦‚å¿µ2\\\"],\\n  \\\"readabilityScore\\\": è¯„åˆ†(1-10)\\n}\"}, {\"role\": \"user\", \"content\": \"è¯·åˆ†æä»¥ä¸‹æ–‡æ¡£å†…å®¹ï¼š\\n\\næ ‡é¢˜ï¼š{{ $json.title }}\\næ–‡æ¡£ç±»å‹ï¼š{{ $json.fileType }}\\n\\nä¸»è¦å†…å®¹ï¼š\\n{{ $json.fullText.substring(0, 8000) }}\\n\\n{{ $json.images ? 'åŒ…å«å›¾ç‰‡ï¼š\\n' + $json.images.map(img => `- ${img.description || img.alt}`).join('\\n') : '' }}\"}]"
            },
            {
              "name": "temperature",
              "value": "0.2"
            },
            {
              "name": "max_tokens",
              "value": "2000"
            }
          ]
        }
      },
      "id": "g7h8i9j0-k1l2-3456-0123-789012345678",
      "name": "LLMå†…å®¹åˆ†æ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1100, 100]
    },
    {
      "parameters": {
        "functionCode": "// å¤„ç†LLMåˆ†æç»“æœå¹¶ç”Ÿæˆç»“æ„åŒ–è¾“å‡º\nfor (const item of $input.all()) {\n  try {\n    const originalData = $('å†…å®¹åˆå¹¶').first().json;\n    const llmResponse = JSON.parse(item.json.choices[0].message.content);\n    \n    // ç»„åˆåˆ†æç»“æœ\n    const analysisResult = {\n      // åŸºç¡€ä¿¡æ¯\n      originalFileName: originalData.originalFileName,\n      fileType: originalData.fileType,\n      processedAt: new Date().toISOString(),\n      \n      // æ–‡æ¡£åˆ†æç»“æœ\n      documentAnalysis: {\n        title: llmResponse.title || originalData.title,\n        theme: llmResponse.theme,\n        summary: llmResponse.summary,\n        keyPoints: llmResponse.keyPoints || [],\n        concepts: llmResponse.concepts || [],\n        readabilityScore: llmResponse.readabilityScore || 5\n      },\n      \n      // è®ºæ®ç´ æ\n      evidenceMaterials: {\n        textual: llmResponse.evidence?.textual || [],\n        visual: llmResponse.evidence?.visual || [],\n        images: originalData.images || [],\n        links: originalData.links || []\n      },\n      \n      // åŸå§‹å†…å®¹ï¼ˆç”¨äºåç»­å¤„ç†ï¼‰\n      sourceContent: {\n        fullText: originalData.fullText,\n        paragraphs: originalData.paragraphs,\n        wordCount: originalData.wordCount,\n        pageCount: originalData.pageCount\n      },\n      \n      // å¤„ç†çŠ¶æ€\n      processingStage: 'analysis_completed',\n      nextStage: 'outline_generation'\n    };\n    \n    item.json = analysisResult;\n    \n  } catch (error) {\n    item.json = {\n      error: 'LLMåˆ†æç»“æœå¤„ç†å¤±è´¥',\n      errorMessage: error.message,\n      originalResponse: item.json,\n      processingStage: 'analysis_failed'\n    };\n  }\n}\n\nreturn $input.all();"
      },
      "id": "h8i9j0k1-l2m3-4567-1234-890123456789",
      "name": "åˆ†æç»“æœå¤„ç†",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 100]
    },
    {
      "parameters": {
        "functionCode": "// ç”Ÿæˆæ˜“è¯»çš„Markdownè¾“å‡ºæ–‡ä»¶\nfor (const item of $input.all()) {\n  const data = item.json;\n  \n  let markdownContent = `# æ–‡æ¡£åˆ†ææŠ¥å‘Š\\n\\n`;\n  markdownContent += `**åŸæ–‡ä»¶åï¼š** ${data.originalFileName}\\n`;\n  markdownContent += `**æ–‡ä»¶ç±»å‹ï¼š** ${data.fileType.toUpperCase()}\\n`;\n  markdownContent += `**å¤„ç†æ—¶é—´ï¼š** ${data.processedAt}\\n`;\n  markdownContent += `**å¯è¯»æ€§è¯„åˆ†ï¼š** ${data.documentAnalysis.readabilityScore}/10\\n\\n`;\n  \n  markdownContent += `## ğŸ“‹ æ–‡æ¡£æ‘˜è¦\\n\\n`;\n  markdownContent += `**ä¸»é¢˜ï¼š** ${data.documentAnalysis.theme}\\n\\n`;\n  markdownContent += `**æ‘˜è¦ï¼š**\\n${data.documentAnalysis.summary}\\n\\n`;\n  \n  markdownContent += `## ğŸ”‘ å…³é”®è¦ç‚¹\\n\\n`;\n  data.documentAnalysis.keyPoints.forEach((point, index) => {\n    markdownContent += `${index + 1}. ${point}\\n`;\n  });\n  markdownContent += `\\n`;\n  \n  markdownContent += `## ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ\\n\\n`;\n  data.documentAnalysis.concepts.forEach((concept, index) => {\n    markdownContent += `- **${concept}**\\n`;\n  });\n  markdownContent += `\\n`;\n  \n  markdownContent += `## ğŸ“ è®ºæ®ç´ æ\\n\\n`;\n  markdownContent += `### æ–‡å­—è®ºæ®\\n\\n`;\n  data.evidenceMaterials.textual.forEach((evidence, index) => {\n    markdownContent += `${index + 1}. ${evidence}\\n`;\n  });\n  markdownContent += `\\n`;\n  \n  if (data.evidenceMaterials.visual.length > 0) {\n    markdownContent += `### å›¾è¡¨è®ºæ®\\n\\n`;\n    data.evidenceMaterials.visual.forEach((visual, index) => {\n      markdownContent += `${index + 1}. ${visual}\\n`;\n    });\n    markdownContent += `\\n`;\n  }\n  \n  if (data.evidenceMaterials.images.length > 0) {\n    markdownContent += `### å›¾ç‰‡èµ„æº\\n\\n`;\n    data.evidenceMaterials.images.forEach((img, index) => {\n      markdownContent += `${index + 1}. **${img.alt || 'å›¾ç‰‡'}**ï¼š${img.description}\\n`;\n      markdownContent += `   - æ¥æºï¼š${img.src}\\n`;\n    });\n    markdownContent += `\\n`;\n  }\n  \n  markdownContent += `## ğŸ“Š æ–‡æ¡£ç»Ÿè®¡\\n\\n`;\n  markdownContent += `- **å­—æ•°ï¼š** ${data.sourceContent.wordCount}\\n`;\n  if (data.sourceContent.pageCount) {\n    markdownContent += `- **é¡µæ•°ï¼š** ${data.sourceContent.pageCount}\\n`;\n  }\n  markdownContent += `- **æ®µè½æ•°ï¼š** ${data.sourceContent.paragraphs.length}\\n`;\n  markdownContent += `- **å›¾ç‰‡æ•°ï¼š** ${data.evidenceMaterials.images.length}\\n`;\n  markdownContent += `- **é“¾æ¥æ•°ï¼š** ${data.evidenceMaterials.links.length}\\n\\n`;\n  \n  markdownContent += `---\\n\\n`;\n  markdownContent += `*æœ¬æŠ¥å‘Šç”±æ–‡æ¡£åˆ†æå·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*\\n`;\n  \n  // ç”Ÿæˆæ–‡ä»¶å\n  const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');\n  const fileName = `document-analysis-${timestamp}.md`;\n  \n  item.json.outputMarkdown = markdownContent;\n  item.json.outputFileName = fileName;\n  item.binary = {\n    data: Buffer.from(markdownContent).toString('base64'),\n    fileName: fileName,\n    mimeType: 'text/markdown'\n  };\n}\n\nreturn $input.all();"
      },
      "id": "i9j0k1l2-m3n4-5678-2345-901234567890",
      "name": "ç”Ÿæˆæ˜“è¯»Markdown",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 100]
    },
    {
      "parameters": {
        "url": "{{ $('ç¯å¢ƒé…ç½®').item.json.outlineWorkflowUrl }}",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "documentAnalysis",
              "value": "={{ $json }}"
            }
          ]
        }
      },
      "id": "j0k1l2m3-n4o5-6789-3456-012345678901",
      "name": "è§¦å‘å¤§çº²ç”Ÿæˆå·¥ä½œæµ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1700, 100]
    },
    {
      "parameters": {
        "message": "âŒ æ–‡ä»¶å¤„ç†å¤±è´¥ï¼š{{ $json.errorMessage }}",
        "additionalFields": {
          "title": "æ–‡æ¡£å¤„ç†é”™è¯¯"
        }
      },
      "id": "k1l2m3n4-o5p6-7890-4567-123456789012",
      "name": "é”™è¯¯é€šçŸ¥",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "llmApiUrl",
              "value": "https://api.openai.com/v1/chat/completions"
            },
            {
              "name": "llmModel", 
              "value": "gpt-4"
            },
            {
              "name": "outlineWorkflowUrl",
              "value": "http://localhost:5678/webhook/outline-generation"
            }
          ]
        }
      },
      "id": "l2m3n4o5-p6q7-8901-5678-234567890123",
      "name": "ç¯å¢ƒé…ç½®",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [100, 300]
    },
    {
      "parameters": {
        "message": "âœ… æ–‡æ¡£åˆ†æå®Œæˆ\\n\\n**æ–‡ä»¶ï¼š** {{ $json.originalFileName }}\\n**ä¸»é¢˜ï¼š** {{ $json.documentAnalysis.theme }}\\n**æ‘˜è¦ï¼š** {{ $json.documentAnalysis.summary.substring(0, 100) }}...\\n\\nä¸‹ä¸€æ­¥ï¼šç”Ÿæˆè®ºæ–‡å¤§çº²",
        "additionalFields": {
          "title": "æ–‡æ¡£å¤„ç†æˆåŠŸ"
        }
      },
      "id": "m3n4o5p6-q7r8-9012-6789-345678901234",
      "name": "æˆåŠŸé€šçŸ¥",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [1900, 100]
    }
  ],
  "connections": {
    "æ–‡ä»¶ä¸Šä¼ è§¦å‘å™¨": {
      "main": [
        [
          {
            "node": "PDFæ–‡ä»¶åˆ¤æ–­",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDFæ–‡ä»¶åˆ¤æ–­": {
      "main": [
        [
          {
            "node": "PDFå†…å®¹æå–",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Markdownå†…å®¹æå–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDFå†…å®¹æå–": {
      "main": [
        [
          {
            "node": "å†…å®¹åˆå¹¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Markdownå†…å®¹æå–": {
      "main": [
        [
          {
            "node": "å†…å®¹åˆå¹¶",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "å†…å®¹åˆå¹¶": {
      "main": [
        [
          {
            "node": "é”™è¯¯æ£€æŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é”™è¯¯æ£€æŸ¥": {
      "main": [
        [
          {
            "node": "LLMå†…å®¹åˆ†æ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "é”™è¯¯é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLMå†…å®¹åˆ†æ": {
      "main": [
        [
          {
            "node": "åˆ†æç»“æœå¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ†æç»“æœå¤„ç†": {
      "main": [
        [
          {
            "node": "ç”Ÿæˆæ˜“è¯»Markdown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç”Ÿæˆæ˜“è¯»Markdown": {
      "main": [
        [
          {
            "node": "è§¦å‘å¤§çº²ç”Ÿæˆå·¥ä½œæµ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§¦å‘å¤§çº²ç”Ÿæˆå·¥ä½œæµ": {
      "main": [
        [
          {
            "node": "æˆåŠŸé€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "main-workflow-v1.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "description": "è®ºæ–‡å†™ä½œä¸»å·¥ä½œæµï¼šå¤„ç†PDF/MDæ–‡ä»¶ä¸Šä¼ ï¼Œæå–å†…å®¹ã€åˆ†æç»“æ„ï¼Œç”Ÿæˆæ˜“è¯»çš„åˆ†ææŠ¥å‘Šå¹¶è§¦å‘åç»­å¤§çº²ç”Ÿæˆæµç¨‹ã€‚æ”¯æŒé”™è¯¯å¤„ç†å’Œäººå·¥å¹²é¢„ç‚¹ã€‚",
    "category": "document-processing",
    "tags": ["è®ºæ–‡å†™ä½œ", "æ–‡æ¡£åˆ†æ", "å†…å®¹æå–", "PDFå¤„ç†", "Markdownå¤„ç†"]
  }
}